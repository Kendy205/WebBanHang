@using WebBanHang.Models.Models
@model IEnumerable<Order>

@{
    ViewData["Title"] = "Quản lý đơn hàng";
    var selectedStatus = ViewBag.SelectedStatus as string;
    var searchTerm = ViewBag.SearchTerm as string;
    int totalPages = ViewBag.TotalPages ?? 1;
    int currentPage = ViewBag.CurrentPage ?? 1;

    int pending = ViewBag.PendingCount ?? 0;
    int confirmed = ViewBag.ConfirmedCount ?? 0;
    int delivering = ViewBag.DeliveringCount ?? 0;
    int completed = ViewBag.CompletedCount ?? 0;
    int cancelled = ViewBag.CancelledCount ?? 0;

    string Active(string s) => string.Equals(selectedStatus, s, StringComparison.OrdinalIgnoreCase) ? "active" : "";
    string Badge(string s) => s switch
    {
        "Pending" => "badge bg-warning text-dark",
        "Confirmed" => "badge bg-info text-dark",
        "Delivering" => "badge bg-primary",
        "Completed" => "badge bg-success",
        "Cancelled" => "badge bg-danger",
        _ => "badge bg-secondary"
    };
}

<div class="row">
    <div class="col-12 grid-margin">
        <div class="card">
            <div class="card-body">

                <h4 class="card-title mb-3">Đơn hàng</h4>

                <!-- Bộ lọc trạng thái -->
                <ul class="nav nav-pills gap-2 mb-3">
                    <li class="nav-item">
                        <a class="nav-link @(string.IsNullOrEmpty(selectedStatus) ? "active" : "")"
                           asp-area="Admin" asp-controller="Orders" asp-action="Index"
                           asp-route-status="" asp-route-searchTerm="@searchTerm">Tất cả</a>
                    </li>
                    <li class="nav-item"><a class="nav-link @Active("Pending")" asp-area="Admin" asp-controller="Orders" asp-action="Index" asp-route-status="Pending" asp-route-searchTerm="@searchTerm">Pending (@pending)</a></li>
                    <li class="nav-item"><a class="nav-link @Active("Confirmed")" asp-area="Admin" asp-controller="Orders" asp-action="Index" asp-route-status="Confirmed" asp-route-searchTerm="@searchTerm">Confirmed (@confirmed)</a></li>
                    <li class="nav-item"><a class="nav-link @Active("Delivering")" asp-area="Admin" asp-controller="Orders" asp-action="Index" asp-route-status="Delivering" asp-route-searchTerm="@searchTerm">Delivering (@delivering)</a></li>
                    <li class="nav-item"><a class="nav-link @Active("Completed")" asp-area="Admin" asp-controller="Orders" asp-action="Index" asp-route-status="Completed" asp-route-searchTerm="@searchTerm">Completed (@completed)</a></li>
                    <li class="nav-item"><a class="nav-link @Active("Cancelled")" asp-area="Admin" asp-controller="Orders" asp-action="Index" asp-route-status="Cancelled" asp-route-searchTerm="@searchTerm">Cancelled (@cancelled)</a></li>
                </ul>

                <!-- Tìm kiếm -->
                <form class="row g-2 mb-3" method="get" asp-area="Admin" asp-controller="Orders" asp-action="Index">
                    <input type="hidden" name="status" value="@selectedStatus" />
                    <div class="col-sm-6 col-md-4">
                        <input class="form-control" name="searchTerm" value="@searchTerm" placeholder="Tìm theo mã đơn / SĐT..." />
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-primary" type="submit">Tìm</button>
                        <a class="btn btn-outline-secondary" asp-area="Admin" asp-controller="Orders" asp-action="Index">Xóa lọc</a>
                    </div>
                </form>

                <!-- Bảng -->
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Mã đơn</th>
                                <th>Khách hàng</th>
                                <th>SĐT</th>
                                <th>Trạng thái</th>
                                <th>Ngày đặt</th>
                                <th>Cập nhật</th>
                                <th class="text-end">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var o in Model)
                            {
                                <tr>
                                    <td>@(o.OrderCode ?? $"#{o.OrderId}")</td>
                                    <td>@(o.User?.FulName ?? $"{o.User?.FirstName} {o.User?.LastName}".Trim() ?? o.User?.Email ?? "—")</td>
                                    <td>@(o.PhoneNumber ?? "—")</td>
                                    <td><span class="@Badge(o.Status)">@o.Status</span></td>
                                    <td>@o.OrderDate.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td>@o.UpdatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td class="text-end">
                                        <a class="btn btn-sm btn-outline-primary"
                                           asp-area="Admin" asp-controller="Orders" asp-action="Details"
                                           asp-route-orderId="@o.OrderId">Chi tiết</a>
                                        <a class="btn btn-sm btn-outline-secondary"
                                           asp-area="Admin" asp-controller="Orders" asp-action="Print"
                                           asp-route-orderId="@o.OrderId" target="_blank">In</a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Phân trang -->
                @if (totalPages > 1)
                {
                    <nav aria-label="Pagination" class="mt-3">
                        <ul class="pagination">
                            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                <a class="page-link"
                                   asp-area="Admin" asp-controller="Orders" asp-action="Index"
                                   asp-route-status="@selectedStatus" asp-route-searchTerm="@searchTerm"
                                   asp-route-page="@(currentPage - 1)">«</a>
                            </li>
                            @for (int i = 1; i <= totalPages; i++)
                            {
                                <li class="page-item @(i == currentPage ? "active" : "")">
                                    <a class="page-link"
                                       asp-area="Admin" asp-controller="Orders" asp-action="Index"
                                       asp-route-status="@selectedStatus" asp-route-searchTerm="@searchTerm"
                                       asp-route-page="@i">@i</a>
                                </li>
                            }
                            <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                <a class="page-link"
                                   asp-area="Admin" asp-controller="Orders" asp-action="Index"
                                   asp-route-status="@selectedStatus" asp-route-searchTerm="@searchTerm"
                                   asp-route-page="@(currentPage + 1)">»</a>
                            </li>
                        </ul>
                    </nav>
                }
            </div>
        </div>
    </div>
</div>
